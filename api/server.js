// Module dependencies.
var application_root = __dirname,
    express = require( 'express' ), //Web framework
    path = require( 'path' ), //Utilities for dealing with file paths
    mongoose = require( 'mongoose' ), //MongoDB integration
    passport = require( 'passport' ), //Authentication Library
    LocalStrategy = require( 'passport-local' ).Strategy,
    cors = require('cors'),
    config = require('./config.json'),  //The configuration file
    router = require( './router' ),
    UserModel = require('./models/UserModel'),
    BookModel = require('./models/BookModel');

// Passport session setup.
//   To support persistent login sessions, Passport needs to be able to
//   serialize users into and deserialize users out of the session.  Typically,
//   this will be as simple as storing the user ID when serializing, and finding
//   the user by ID when deserializing.
passport.serializeUser(function(user, done) {
    done(null, user.id);
});

passport.deserializeUser(function(id, done) {
    UserModel.findById(id, function (err, user) {
        done(err, user);
    });
});

// Use the LocalStrategy within Passport.
//   Strategies in passport require a `verify` function, which accept
//   credentials (in this case, a username and password), and invoke a callback
//   with a user object.  In the real world, this would query a database;
//   however, in this example we are using a baked-in set of users.
passport.use(new LocalStrategy(function(username, password, done) {
    UserModel.findOne({ username: username }, function(err, user) {
        if (err) { return done(err); }
        if (!user) { return done(null, false, { message: 'Unknown user ' + username }); }
        user.comparePassword(password, function(err, isMatch) {
            if (err) return done(err);
            if(isMatch) {
                console.log("yes");
                return done(null, user);
            } else {
                console.log("no");
                return done(null, false, { message: 'Invalid password' });
            }
        });
    });
}));

//Create server
var app = express();

// Configure server
app.configure( function() {
    //parses request cookies and populates req.cookies
    app.use(express.cookieParser());

    //parses request body and populates request.body
    app.use( express.bodyParser() );

    //checks request.body for HTTP method overrides
    app.use( express.methodOverride() );

    //checks the session using the cookies and populates req.session
    app.use(express.session({ secret: 'keyboard catterpillar' }));
    // Initialize Passport!  Also use passport.session() middleware, to support
    // persistent login sessions (recommended).
    app.use(passport.initialize());
    app.use(passport.session());

    //TODO: Make stricter control over CORS origins https://www.npmjs.org/package/cors
    app.use(cors());

    //perform route lookup based on url and HTTP method
    app.use( app.router );

    //Where to serve static content
    app.use( express.static( path.join( application_root, 'site') ) );

    //Show all errors in development
    app.use( express.errorHandler({ dumpExceptions: true, showStack: true }));
});

//Connect to database
mongoose.connect( config.database_url );

// Initialize the models
UserModel = UserModel.init(mongoose);
BookModel = BookModel.init(mongoose);

// Routes
router.registerRoutes(app, mongoose, passport);

//Start server
var port = config.app_port;
app.listen( port, function() {
    console.log( 'Express server listening on port %d in %s mode', port, app.settings.env );
});